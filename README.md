# Nemesis ‚Äî API Guardian

**Nemesis** est un package Laravel de s√©curit√© API et son r√¥le est de prot√©ger vos APIs contre les abus et les utilisations non autoris√©es en combinant :

* üîë **Gestion des tokens** associ√©s √† des domaines sp√©cifiques.
* üåç **Contr√¥le CORS par token** (chaque token est li√© √† un ou plusieurs domaines).
* üìä **Quota d'appels** avec suivi en base de donn√©es.
* üö® **Blocage automatique** si un token d√©passe sa limite d'utilisation.

Nemesis agit comme un **gardien implacable** de vos endpoints.

---

## üöÄ Installation

Ajoutez le package √† votre projet Laravel :

```bash
composer require kani/laravel-nemesis
```

Publiez les fichiers de configuration et les migrations :

```bash
php artisan vendor:publish --provider="Kani\Nemesis\NemesisServiceProvider"
php artisan migrate
```

---

## ‚öôÔ∏è CONFIGURATION IMPORTANTE POUR LES PROJETS LARAVEL

### 1. Installation de l'API Laravel

**IMPERATIF** : Pour √©viter les probl√®mes CORS (Cross-Origin) lors des appels depuis un frontend web, vous devez installer le syst√®me d'API Laravel :

```bash
php artisan install:api
```

Cette commande installe Laravel Sanctum et cr√©e le fichier `routes/api.php` n√©cessaire pour les routes stateless.

### 2. Configuration des routes API

**TOUTES LES ROUTES PROT√âG√âES PAR NEMESIS DOIVENT √äTRE D√âFINIES DANS `routes/api.php`** :

```php
// routes/api.php
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;

Route::middleware(['nemesis'])->group(function () {
    Route::get('/posts', function (Request $request) {
        return response()->json(['data' => 'Posts list']);
    });

    Route::get('/profile', function (Request $request) {
        return response()->json(['data' => 'User profile']);
    });
});
```

### 3. Configuration du middleware dans bootstrap/app.php

Ajoutez l'alias du middleware Nemesis dans votre fichier `bootstrap/app.php` :

```php
// bootstrap/app.php
use Kani\Nemesis\Http\Middleware\NemesisMiddleware;

->withMiddleware(function (Middleware $middleware) {
    $middleware->alias([
        'nemesis' => NemesisMiddleware::class,
        // autres middlewares...
    ]);
})

// Optionnel : changement du pr√©fixe API
->withRouting(
    api: __DIR__.'/../routes/api.php',
    apiPrefix: 'api/admin', // ou conservez 'api' par d√©faut
    // ...
)
```

---

## ‚öôÔ∏è Configuration du package

Apr√®s publication, le fichier `config/nemesis.php` est disponible :

```php
return [
    'default_max_requests' => 1000, // nombre maximum d'appels par token
    'reset_period' => 'daily',      // peut √™tre 'daily', 'weekly', 'monthly'
    'block_response' => [
        'message' => 'Acc√®s refus√© : quota d√©pass√© ou domaine non autoris√©.',
        'status' => 429,
    ],
];
```

üí° **Astuce** : `default_max_requests` centralise les quotas par d√©faut, pour ne pas r√©p√©ter la valeur dans toutes les commandes.

---

## üóÑÔ∏è Migration

La migration cr√©e une table `nemesis_tokens` avec les colonnes suivantes :

* `id`
* `token` (string unique)
* `allowed_origins` (json : liste des domaines autoris√©s)
* `max_requests` (integer : limite d'appels)
* `requests_count` (integer : nombre d'appels effectu√©s)
* `last_request_at` (datetime : date du dernier appel)
* `created_at`, `updated_at` (timestamps)

---

## üõ°Ô∏è Middleware

### Utilisation du middleware

Le middleware Nemesis est maintenant automatiquement enregistr√© par le package. Vous pouvez l'utiliser directement avec son alias `nemesis` :

```php
// routes/api.php
Route::middleware('nemesis')->group(function () {
    Route::get('/posts', [PostController::class, 'index']);
    Route::get('/profile', [UserController::class, 'show']);
});
```

### Transmission du token

Le token peut √™tre transmis de deux mani√®res :

#### 1. Via l'en-t√™te Authorization (Bearer)
```javascript
const API_TOKEN = 'crrxnjbAucrzMl8FvlRDQHwJSmvET05ncqcX3LuO';

fetch('http://localhost:8000/api/posts', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${API_TOKEN}`,
    'Content-Type': 'application/json',
  },
})
```

#### 2. Via le param√®tre de query string
```javascript
const API_TOKEN = 'crrxnjbAucrzMl8FvlRDQHwJSmvET05ncqcX3LuO';

fetch(`http://localhost:8000/api/posts?token=${API_TOKEN}`, {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json',
  },
})
```

### Fonctionnement du middleware

1. Si l'origine (`Origin`) est **identique au domaine de l'application** ou absente, la requ√™te passe **sans v√©rification du token**.
2. V√©rifie que le **token existe** et n'est pas bloqu√©.
3. V√©rifie que l'**origine** (domaine) est autoris√©e (`allowed_origins`) pour ce token.
4. **Accepte le token soit via l'en-t√™te `Authorization: Bearer TOKEN`, soit via le param√®tre query `?token=TOKEN`.**
5. V√©rifie le quota et **incr√©mente le compteur** `requests_count`.
6. Bloque la requ√™te si la limite `max_requests` est atteinte.
7. R√©pond avec les **headers CORS appropri√©s**, y compris la gestion des requ√™tes `OPTIONS` (preflight).

üí° **Astuce** : si votre frontend est sur le m√™me domaine que l'API, vous n'avez **pas besoin de token** pour les requ√™tes internes.

**Flux simplifi√© :**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Requ√™te API ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ R√©cup√®re    ‚îÇ
‚îÇ token       ‚îÇ
‚îÇ (header ou  ‚îÇ
‚îÇ query)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ V√©rif token ‚îÇ
‚îÇ existe et   ‚îÇ
‚îÇ non bloqu√©  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ V√©rif orig. ‚îÇ
‚îÇ autoris√©e ? ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Compteur    ‚îÇ
‚îÇ incr√©ment√©  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Limite OK ? ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ
      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ R√©ponse API ‚îÇ
‚îÇ + CORS      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

# üîß Commandes Artisan Nemesis

## üìã Liste des Commandes Disponibles

### 1Ô∏è‚É£ `nemesis:create` - Cr√©er un nouveau token API
```bash
php artisan nemesis:create [--origins=*] [--max=] [--name=]
```

**Param√®tres :**
- `--origins` : (Optionnel, multiple) Domaines autoris√©s √† utiliser ce token
  - Format : `--origins=https://site1.com --origins=https://site2.com`
  - Par d√©faut : `['*']` (tous les domaines autoris√©s)
- `--max` : (Optionnel) Nombre maximum de requ√™tes autoris√©es
  - Par d√©faut : valeur d√©finie dans `config/nemesis.php` (g√©n√©ralement 1000)
- `--name` : (Optionnel) Nom descriptif pour identifier le token

**Exemples :**
```bash
# Cr√©er un token avec des domaines sp√©cifiques
php artisan nemesis:create --origins=https://monsite.com --origins=https://api.monsite.com

# Cr√©er un token avec une limite personnalis√©e
php artisan nemesis:create --max=5000 --origins=https://client-site.com

# Cr√©er un token avec un nom descriptif
php artisan nemesis:create --name="Token pour application mobile"

# Cr√©er un token avec tous les param√®tres
php artisan nemesis:create --origins=https://production.com --max=10000 --name="Token production"
```

**Exemple de sortie :**
```
‚úÖ Nemesis token created successfully!

Token: AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza
Max Requests: 5000
Allowed Origins: ["https://monsite.com","https://api.monsite.com"]
Name: Token pour application mobile

‚ö†Ô∏è  Important: Save this token securely as it cannot be retrieved later!
```

---

### 2Ô∏è‚É£ `nemesis:reset` - R√©initialiser les quotas d'utilisation
```bash
php artisan nemesis:reset [--token=] [--force]
```

**Param√®tres :**
- `--token` : (Optionnel) R√©initialiser uniquement un token sp√©cifique
- `--force` : (Optionnel) Forcer la r√©initialisation sans confirmation

**Fonctionnement :**
- R√©initialise le compteur `requests_count` √† 0
- Remet √† null la date `last_request_at`
- Affecte tous les tokens si aucun token sp√©cifique n'est pr√©cis√©

**Exemples :**
```bash
# R√©initialiser tous les tokens (avec confirmation)
php artisan nemesis:reset

# R√©initialiser tous les tokens sans confirmation
php artisan nemesis:reset --force

# R√©initialiser un token sp√©cifique
php artisan nemesis:reset --token=AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza
```

**Exemple de sortie :**
```
Are you sure you want to reset all token quotas? (yes/no) [no]:
> yes

‚úÖ Successfully reset quotas for 15 tokens.
```

---

### 3Ô∏è‚É£ `nemesis:block` - Bloquer un token
```bash
php artisan nemesis:block {token} [--reason=]
```

**Param√®tres :**
- `token` : (Requis) Le token √† bloquer
- `--reason` : (Optionnel) Raison du blocage pour documentation

**Fonctionnement :**
- Met la valeur de `max_requests` √† 0
- Le token ne peut plus √™tre utilis√© pour des appels API
- Le blocage est r√©versible avec la commande `nemesis:unblock`

**Exemples :**
```bash
# Bloquer un token
php artisan nemesis:block AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza

# Bloquer un token avec une raison
php artisan nemesis:block AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza --reason="Abuse detected"
```

**Exemple de sortie :**
```
‚úÖ Token AbC123XyZ... has been blocked successfully.
Reason: Abuse detected
```

---

### 4Ô∏è‚É£ `nemesis:unblock` - D√©bloquer un token
```bash
php artisan nemesis:unblock {token} [--max=] [--reason=]
```

**Param√®tres :**
- `token` : (Requis) Le token √† d√©bloquer
- `--max` : (Optionnel) Nouvelle limite de requ√™tes
  - Par d√©faut : valeur d√©finie dans `config/nemesis.php`
- `--reason` : (Optionnel) Raison du d√©blocage

**Exemples :**
```bash
# D√©bloquer un token avec la limite par d√©faut
php artisan nemesis:unblock AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza

# D√©bloquer avec une limite personnalis√©e
php artisan nemesis:unblock AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza --max=2000

# D√©bloquer avec une raison
php artisan nemesis:unblock AbC123XyZdef456Uvw789Ghi012Jkl345Mno678Pqr901Stu234Vwx567Yza --reason="Issue resolved"
```

**Exemple de sortie :**
```
‚úÖ Token AbC123XyZ... has been unblocked successfully.
New max requests: 2000
Reason: Issue resolved
```

---

### 5Ô∏è‚É£ `nemesis:list` - Lister tous les tokens (Nouvelle commande)
```bash
php artisan nemesis:list [--status=]
```

**Param√®tres :**
- `--status` : (Optionnel) Filtrer par status: `active`, `blocked`, `all`

**Exemples :**
```bash
# Lister tous les tokens
php artisan nemesis:list

# Lister seulement les tokens actifs
php artisan nemesis:list --status=active

# Lister seulement les tokens bloqu√©s
php artisan nemesis:list --status=blocked
```

**Exemple de sortie :**
```
üìã Nemesis Tokens List (Showing 3 of 15 tokens)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Name         ‚îÇ Token (truncated)                         ‚îÇ Status      ‚îÇ Usage  ‚îÇ Last Used    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Mobile App   ‚îÇ AbC123XyZ...                              ‚îÇ ‚úÖ Active   ‚îÇ 250/1K ‚îÇ 2 hours ago  ‚îÇ
‚îÇ Production   ‚îÇ Def456Uvw...                              ‚îÇ ‚úÖ Active   ‚îÇ 980/10K‚îÇ 5 minutes ago‚îÇ
‚îÇ Test Client  ‚îÇ Ghi012Jkl...                              ‚îÇ üö´ Blocked  ‚îÇ 0/0    ‚îÇ Never        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Bonnes Pratiques pour les Commandes

1. **S√©curit√© des Tokens** :
   - Les tokens sont affich√©s une seule fois √† la cr√©ation
   - Stockez-les dans un gestionnaire de mots de passe s√©curis√©
   - Utilisez des variables d'environnement en production

2. **Gestion des Quotas** :
   - Planifiez la r√©initialisation r√©guli√®re avec `php artisan nemesis:reset`
   - Utilisez `php artisan schedule:run` pour l'automatisation

3. **Surveillance** :
   - Utilisez r√©guli√®rement `nemesis:list` pour monitorer l'utilisation
   - Bloquez rapidement les tokens suspects

4. **Documentation** :
   - Utilisez le param√®tre `--name` pour identifier clairement chaque token
   - Documentez les raisons de blocage/d√©blocage avec `--reason`

## ‚öôÔ∏è Int√©gration avec la Planification Laravel

Ajoutez √† votre `app/Console/Kernel.php` pour automatiser les t√¢ches :

```php
protected function schedule(Schedule $schedule)
{
    // R√©initialiser les quotas tous les jours √† minuit
    $schedule->command('nemesis:reset --force')->daily();

    // Lister l'√©tat des tokens chaque lundi
    $schedule->command('nemesis:list --status=active')->weeklyOn(1, '8:00');
}
```

Ces commandes offrent une gestion compl√®te de vos tokens API Nemesis, permettant un contr√¥le pr√©cis de l'acc√®s et des quotas d'utilisation.

---

## üìå Exemple concret

Prot√©geons un endpoint `api/posts` dans `routes/api.php` :

```php
// routes/api.php
Route::middleware(['nemesis'])->get('/posts', [PostController::class, 'index']);
```

### Requ√™te avec token valide (header)

```http
GET /api/posts HTTP/1.1
Host: api.monsite.com
Authorization: Bearer VOTRE_TOKEN
Origin: https://monsite.com
```

‚úÖ R√©sultat : acc√®s autoris√©.

### Requ√™te avec token valide (query param)

```http
GET /api/posts?token=VOTRE_TOKEN HTTP/1.1
Host: api.monsite.com
Origin: https://monsite.com
```

‚úÖ R√©sultat : acc√®s autoris√©.

### Requ√™te depuis un autre domaine

```http
GET /api/posts?token=VOTRE_TOKEN HTTP/1.1
Host: api.monsite.com
Origin: https://sitepirate.com
```

‚ùå R√©sultat : `429 Acc√®s refus√© : quota d√©pass√© ou domaine non autoris√©.`

---

## üõ†Ô∏è Bonnes pratiques

* ‚úÖ **IMPERATIF** : D√©finissez vos routes prot√©g√©es dans `routes/api.php`
* ‚úÖ Utilisez un quota adapt√© pour chaque client.
* üîÑ Activez un reset automatique des quotas.
* üîê Ne communiquez jamais vos tokens c√¥t√© client sans contr√¥le.
* üìä Surveillez les logs Nemesis pour d√©tecter les abus.

---

## üîí S√©curit√©

* Les tokens sont **hach√©s** en base de donn√©es.
* Les tokens ne peuvent √™tre utilis√©s que depuis les origines autoris√©es.
* Les tentatives √©chou√©es sont logu√©es pour suivi.

---

## üö® D√©pannage

### Erreur CORS persistante

**Solution :** V√©rifiez que :
1. Vous avez bien ex√©cut√© `php artisan install:api`
2. Vos routes sont bien d√©finies dans `routes/api.php`
3. Le middleware est bien alias√© dans `bootstrap/app.php`

### Erreur lors de la d√©sinstallation

```bash
Class "Kani\Nemesis\NemesisServiceProvider" not found
```

**Solution :**

```bash
# Supprimer les caches
rm -f bootstrap/cache/*.php
php artisan config:clear

# Supprimer le provider
sed -i '/Kani\\Nemesis\\NemesisServiceProvider/d' config/app.php

# Supprimer config publi√©
rm -f config/nemesis.php

# Vider tous les caches Laravel
php artisan optimize:clear

# D√©sinstaller le package
composer remove kani/laravel-nemesis
```

### Pour Windows

```cmd
del /Q bootstrap\cache\*.php
php artisan optimize:clear
composer remove kani/laravel-nemesis
```

---

## üë§ Auteur

D√©velopp√© par **Andr√© Kani** ‚Äî Inspir√© de la justice implacable de **N√©m√©sis**.

---

## üìú Licence

MIT. Libre d'utilisation et de modification.